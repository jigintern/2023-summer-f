<!DOCTYPE html>
<html lang="ja">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <title>ã‚¢ãƒ©ãƒ¼ãƒ -WAAAAAsh!!</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
  <link rel="stylesheet" href="alarm.css">

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Ropa+Sans" rel="stylesheet">





</head>


<script>
  //æ™‚è¨ˆã®è¡¨ç¤º
  const clock = () => {
    // ç¾åœ¨ã®æ—¥æ™‚ãƒ»æ™‚åˆ»ã®æƒ…å ±ã‚’å–å¾—
    const d = new Date();

    // å¹´ã‚’å–å¾—
    let year = d.getFullYear();
    // æœˆã‚’å–å¾—
    let month = d.getMonth() + 1;
    // æ—¥ã‚’å–å¾—
    let date = d.getDate();
    // æ›œæ—¥ã‚’å–å¾—
    let dayNum = d.getDay();
    const weekday = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
    let day = weekday[dayNum];
    // æ™‚ã‚’å–å¾—
    let hour = d.getHours();
    // åˆ†ã‚’å–å¾—
    let min = d.getMinutes();
    // ç§’ã‚’å–å¾—
    //let sec = d.getSeconds();

    // 1æ¡ã®å ´åˆã¯0ã‚’è¶³ã—ã¦2æ¡ã«
    month = month < 10 ? "0" + month : month;
    date = date < 10 ? "0" + date : date;
    hour = hour < 10 ? "0" + hour : hour;
    min = min < 10 ? "0" + min : min;
    //sec = sec < 10 ? "0" + sec : sec;

    // æ—¥ä»˜ãƒ»æ™‚åˆ»ã®æ–‡å­—åˆ—ã‚’ä½œæˆ
    let today = `${year}.${month}.${date} ${day}`;
    let time = `${hour}:${min}`;

    // æ–‡å­—åˆ—ã‚’å‡ºåŠ›
    document.querySelector(".clock-date").innerText = today;
    document.querySelector(".clock-time").innerText = time;
  };

  // 1ç§’ã”ã¨ã«clocké–¢æ•°ã‚’å‘¼ã³å‡ºã™
  setInterval(clock, 1000);




</script>

<body>
  <div class="flex">
    <!-- <div class="content" > -->
      <button id="sleep_button">ã‚‚ã†å¯ã‚‹</button>
    <!-- </div> -->
  </div>
  


  <!-- æ™‚è¨ˆã®è¡¨ç¤º -->
  <div id="container" class="container" hidden>
    <div id="clock" class="clock" hidden>
      <p id="clock-date" class="clock-date" hidden></p>
      <p id="clock-time" class="clock-time" hidden></p>
      <button id="stop_button" hidden>QRã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    </div>
  </div>

</body>




<script>

  document.getElementById("sleep_button").onclick = async () => {
    const sleep_button = document.getElementById("sleep_button")
    sleep_button.hidden = true;
    const id = localStorage.getItem("user_id");
    const response = await fetch("/time_get", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id })
    }).then((res) => {
      return res.json(); // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦è§£æ
    }).then((data) => {
      //ã‚¢ãƒ©ãƒ¼ãƒ ã¾ã§ã®æ™‚é–“ã‚’è¨ˆç®—
      let date1 = new Date();
      let date2 = new Date(data.wake_up_time)
      var diff = date2.getTime() - date1.getTime();
      console.log(diff / (1000));


      //ã‚¢ãƒ©ãƒ¼ãƒ æ©Ÿèƒ½
      setTimeout(() => {
        document.body.style.backgroundColor = "#F2D4A4";
        // document.bgColor = "#F2D4A4";
        const container = document.getElementById("container")
        const clock1 = document.getElementById("clock")
        const clock_date = document.getElementById("clock-date")
        const clock_time = document.getElementById("clock-time")
        const stop_button = document.getElementById("stop_button")
        container.hidden = false;
        clock1.hidden = false;
        clock_date.hidden = false;
        clock_time.hidden = false;
        stop_button.hidden = false;

        let sound = new Howl({
          src: ['clock_alarm.mp3'],
          loop: true

        });
        sound.play();
      }, diff);
    }).catch((e) => {
      console.error(e)
    });
  }


</script>

<style>
  body {
    font-family: 'Ropa Sans', sans-serif;
    color: #333;
    max-width: 640px;
    margin: 0 auto;
    position: relative;
  }


  #loadingMessage {
    text-align: center;
    padding: 40px;
    background-color: #eee;
  }

  #canvas {
    width: 100%;
  }

  #output {
    margin-top: 20px;
    background: #eee;
    padding: 10px;
    padding-bottom: 0;
  }

  #output div {
    padding-bottom: 10px;
    word-wrap: break-word;
  }
</style>
</head>

<body>
  <!--<div id="loadingMessage">ğŸ¥ Unable to access video stream (please make sure you have a webcam enabled)</div> -->
  <canvas id="canvas" hidden></canvas>
  <!-- <div id="output" hidden>
    <div id="outputMessage" hidden>æ¤œå‡ºä¸­......</div>
    <div hidden id="ok">èª­ã¿å–ã‚ŠæˆåŠŸ</div>
  </div> -->


  <script>
    const video = document.createElement("video");
    const canvasElement = document.getElementById("canvas");
    const canvas = canvasElement.getContext("2d");
    const loadingMessage = document.getElementById("loadingMessage");
    const outputContainer = document.getElementById("output");
    const outputMessage = document.getElementById("outputMessage");
    // const ok = document.getElementById("ok");
    let qrtxt;

    document.getElementById("stop_button").onclick = () => {
      canvasElement.hidden = false;
      const container = document.getElementById("container")
      const clock1 = document.getElementById("clock")
      const clock_date = document.getElementById("clock-date")
      const clock_time = document.getElementById("clock-time")
      const stop_button = document.getElementById("stop_button")
      container.hidden = true;
      clock1.hidden = true;
      clock_date.hidden = true;
      clock_time.hidden = true;
      stop_button.hidden = true;
    }

    function drawLine(begin, end, color) {
      canvas.beginPath();
      canvas.moveTo(begin.x, begin.y);
      canvas.lineTo(end.x, end.y);
      canvas.lineWidth = 4;
      canvas.strokeStyle = color;
      canvas.stroke();
    }

    // Use facingMode: environment to attemt to get the front camera on phones
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function (stream) {
      video.srcObject = stream;
      video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
      video.play();
      requestAnimationFrame(tick);
    });

    function tick() {
      // loadingMessage.innerText = "âŒ› Loading video..."
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // loadingMessage.hidden = true;

        // outputContainer.hidden = false;

        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });
        if (code) {
          drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
          drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
          drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
          drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
          qrtxt = code.data
          if (qrtxt === "https://2023-summer-f.deno.dev/sleeper.html") {
            window.location.href = '/wash_time.html';
            // outputMessage.hidden = true;
            // ok.hidden = false;
          }
        } else {
          // outputMessage.hidden = false;
          // ok.hidden = true;
        }
      }
      requestAnimationFrame(tick);
    }



  </script>

</html>